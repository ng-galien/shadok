plugins {
    `java-platform`
    alias(libs.plugins.spotless) apply false
}

description = "Shadok Parent - BOM for dependency management"

javaPlatform {
    allowDependencies()
}

dependencies {
    // Import external BOMs
    api(platform(libs.quarkus.bom))
    api(platform(libs.quarkus.operator.sdk.bom))
    
    constraints {
        // Additional dependencies
        api(libs.kubernetes.webhooks.core)
    }
}

// Subprojects configuration
subprojects {
    apply(plugin = "java")
    apply(plugin = "java-library")
    apply(plugin = "com.diffplug.spotless")
    
    group = findProperty("group") as String
    version = findProperty("version") as String
    
    configure<JavaPluginExtension> {
        toolchain {
            languageVersion.set(JavaLanguageVersion.of(21))
        }
        withSourcesJar()
    }
    
    // Common repositories
    repositories {
        mavenCentral()
    }
    
    // Common test configuration
    tasks.withType<Test> {
        useJUnitPlatform()
        systemProperty("java.util.logging.manager", "org.jboss.logmanager.LogManager")
        // jvmArgs("-XX:+StartFlightRecording")  // Disabled due to JVM compatibility issues
    }
    
    // Spotless configuration
    configure<com.diffplug.gradle.spotless.SpotlessExtension> {
        java {
            googleJavaFormat(libs.versions.google.java.format.get())
            removeUnusedImports()
            target("src/**/*.java")
        }
        
        format("markdown") {
            target("**/*.md")
            targetExclude("**/venv/**", "**/node_modules/**", "**/build/**", "**/target/**")
            prettier().config(mapOf(
                "parser" to "markdown",
                "proseWrap" to "always",
                "printWidth" to 80,
                "tabWidth" to 2
            ))
        }
        
        // Configuration TOML simplifi√©e (sans prettier pour √©viter les d√©pendances)
        format("toml") {
            target("**/*.toml")
            targetExclude("**/venv/**", "**/node_modules/**", "**/build/**", "**/target/**")
            // Utilise un formatteur simple pour la coh√©rence d'indentation
            indentWithSpaces(2)
            trimTrailingWhitespace()
            endWithNewline()
        }
    }
    
    // Compilation configuration
    tasks.withType<JavaCompile> {
        options.encoding = "UTF-8"
        options.compilerArgs.addAll(listOf("-parameters"))
    }
}

// =========================
// Python Pods Management
// =========================

val pythonPodDir = file("pods/python-hello")
val pythonSrcDir = file("$pythonPodDir/src")
val pythonTestsDir = file("$pythonPodDir/tests")
val pythonVenvDir = file("$pythonPodDir/venv")

// Task to check if Python is available
tasks.register("checkPython", Exec::class) {
    group = "python-pods"
    description = "Check if Python 3 is available"
    
    commandLine = if (System.getProperty("os.name").lowercase().contains("windows")) {
        listOf("python", "--version")
    } else {
        listOf("python3", "--version")
    }
    
    doFirst {
        println("üêç Checking Python availability...")
    }
    
    doLast {
        println("‚úÖ Python is available")
    }
}

// Task to create Python virtual environment
tasks.register("createPythonVenv", Exec::class) {
    group = "python-pods"
    description = "Create Python virtual environment for python-hello pod"
    dependsOn("checkPython")
    
    onlyIf { !pythonVenvDir.exists() }
    
    workingDir = pythonPodDir
    commandLine = if (System.getProperty("os.name").lowercase().contains("windows")) {
        listOf("python", "-m", "venv", "venv")
    } else {
        listOf("python3", "-m", "venv", "venv")
    }
    
    doFirst {
        println("üîß Creating Python virtual environment...")
    }
    
    doLast {
        println("‚úÖ Virtual environment created at ${pythonVenvDir.absolutePath}")
    }
}

// Task to install Python dependencies
tasks.register("installPythonDeps", Exec::class) {
    group = "python-pods"
    description = "Install Python dependencies for python-hello pod"
    dependsOn("createPythonVenv")
    
    workingDir = pythonPodDir
    
    commandLine = if (System.getProperty("os.name").lowercase().contains("windows")) {
        listOf("venv\\Scripts\\pip.exe", "install", "--upgrade", "pip")
    } else {
        listOf("venv/bin/pip", "install", "--upgrade", "pip")
    }
    
    doFirst {
        println("üì¶ Installing Python dependencies...")
    }
    
    doLast {
        // Install requirements
        project.exec {
            workingDir = pythonPodDir
            commandLine = if (System.getProperty("os.name").lowercase().contains("windows")) {
                listOf("venv\\Scripts\\pip.exe", "install", "-r", "requirements.txt")
            } else {
                listOf("venv/bin/pip", "install", "-r", "requirements.txt")
            }
        }
        println("‚úÖ Python dependencies installed")
    }
}

// Task to run Python tests
tasks.register("runPythonTests", Exec::class) {
    group = "python-pods"
    description = "Run tests for python-hello pod"
    dependsOn("installPythonDeps")
    
    workingDir = pythonPodDir
    
    commandLine = if (System.getProperty("os.name").lowercase().contains("windows")) {
        listOf("venv\\Scripts\\python.exe", "-m", "pytest", "tests/", "-v")
    } else {
        listOf("venv/bin/python", "-m", "pytest", "tests/", "-v")
    }
    
    doFirst {
        println("üß™ Running Python tests...")
    }
    
    doLast {
        println("‚úÖ Python tests completed")
    }
}

// Task to run Python app in development mode
tasks.register("runPythonDev", Exec::class) {
    group = "python-pods"
    description = "Run python-hello pod in development mode"
    dependsOn("installPythonDeps")
    
    workingDir = pythonSrcDir
    
    commandLine = if (System.getProperty("os.name").lowercase().contains("windows")) {
        listOf("..\\venv\\Scripts\\python.exe", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload")
    } else {
        listOf("../venv/bin/python", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload")
    }
    
    doFirst {
        println("üöÄ Starting Python app in development mode...")
        println("üìç Application will be available at: http://localhost:8000")
        println("üìã API documentation at: http://localhost:8000/docs")
        println("üõë Press Ctrl+C to stop")
    }
}

// Task to build Python Docker image
tasks.register("buildPythonImage", Exec::class) {
    group = "python-pods"
    description = "Build Docker image for python-hello pod"
    
    workingDir = pythonPodDir
    commandLine = listOf("docker", "build", "-t", "shadok-pods/python-hello:latest", ".")
    
    doFirst {
        println("üê≥ Building Python Docker image...")
    }
    
    doLast {
        println("‚úÖ Docker image built: shadok-pods/python-hello:latest")
    }
}

// Task to run Python app with Docker Compose
tasks.register("runPythonDocker", Exec::class) {
    group = "python-pods"
    description = "Run python-hello pod with Docker Compose"
    dependsOn("buildPythonImage")
    
    workingDir = pythonPodDir
    commandLine = listOf("docker-compose", "up", "--build")
    
    doFirst {
        println("üê≥ Starting Python app with Docker Compose...")
        println("üìç Application will be available at: http://localhost:8000")
        println("üõë Use Ctrl+C then 'docker-compose down' to stop")
    }
}

// Task to clean Python environment
tasks.register("cleanPython", Delete::class) {
    group = "python-pods"
    description = "Clean Python virtual environment and cache files"
    
    delete(pythonVenvDir)
    delete(fileTree(pythonPodDir).matching {
        include("**/__pycache__/**")
        include("**/*.pyc")
        include("**/*.pyo")
        include("**/.pytest_cache/**")
    })
    
    doLast {
        println("üßπ Python environment cleaned")
    }
}

// Task to show Python pod status
tasks.register("pythonStatus") {
    group = "python-pods"
    description = "Show status of python-hello pod"
    
    doLast {
        println("üìä Python Hello World Pod Status")
        println("=".repeat(40))
        println("üìÅ Pod directory: ${pythonPodDir.absolutePath}")
        println("üêç Virtual env: ${if (pythonVenvDir.exists()) "‚úÖ Created" else "‚ùå Not found"}")
        println("üì¶ Dependencies: ${if (file("$pythonVenvDir/pyvenv.cfg").exists()) "‚úÖ Installed" else "‚ùå Not installed"}")
        println("üß™ Tests: Run './gradlew runPythonTests' to execute")
        println("üöÄ Dev mode: Run './gradlew runPythonDev' to start")
        println("üê≥ Docker: Run './gradlew runPythonDocker' to start with Docker")
        println("=".repeat(40))
    }
}

// Aggregate task for complete Python setup
tasks.register("setupPython") {
    group = "python-pods"
    description = "Complete setup of python-hello pod (install deps and run tests)"
    dependsOn("runPythonTests")
    
    doLast {
        println("üéâ Python Hello World pod setup completed!")
        println("üí° Next steps:")
        println("   - Run dev mode: ./gradlew runPythonDev")
        println("   - Build Docker: ./gradlew buildPythonImage") 
        println("   - Check status: ./gradlew pythonStatus")
    }
}

// =========================
// Quarkus Pods Management  
// =========================

val quarkusPodDir = file("pods/quarkus-hello")

// Task to build Quarkus pod
tasks.register("buildQuarkusPod", GradleBuild::class) {
    group = "quarkus-pods"
    description = "Build quarkus-hello pod"
    
    dir = quarkusPodDir
    tasks = listOf("build")
    
    doFirst {
        println("‚ö° Building Quarkus pod...")
    }
    
    doLast {
        println("‚úÖ Quarkus pod built successfully")
    }
}

// Task to test Quarkus pod
tasks.register("testQuarkusPod", GradleBuild::class) {
    group = "quarkus-pods"
    description = "Run tests for quarkus-hello pod"
    
    dir = quarkusPodDir
    tasks = listOf("test")
    
    doFirst {
        println("üß™ Running Quarkus tests...")
    }
    
    doLast {
        println("‚úÖ Quarkus tests completed")
    }
}

// Task to run Quarkus pod in dev mode
tasks.register("runQuarkusDev", GradleBuild::class) {
    group = "quarkus-pods"
    description = "Run quarkus-hello pod in development mode"
    
    dir = quarkusPodDir
    tasks = listOf("quarkusDev")
    
    doFirst {
        println("‚ö° Starting Quarkus in dev mode...")
        println("üìç Application will be available at: http://localhost:8080")
        println("üõë Press 'q' then Enter to stop")
    }
}

// Task to generate Kubernetes manifests for Quarkus
tasks.register("generateQuarkusK8s", GradleBuild::class) {
    group = "quarkus-pods"
    description = "Generate Kubernetes manifests for quarkus-hello pod"
    
    dir = quarkusPodDir
    tasks = listOf("build")
    
    doLast {
        val k8sDir = file("$quarkusPodDir/build/kubernetes")
        if (k8sDir.exists()) {
            println("‚úÖ Kubernetes manifests generated in: ${k8sDir.absolutePath}")
            k8sDir.listFiles()?.forEach { file ->
                println("   üìÑ ${file.name}")
            }
        }
    }
}

// Task to clean Quarkus pod
tasks.register("cleanQuarkusPod", GradleBuild::class) {
    group = "quarkus-pods"
    description = "Clean quarkus-hello pod build artifacts"
    
    dir = quarkusPodDir
    tasks = listOf("clean")
    
    doLast {
        println("üßπ Quarkus pod cleaned")
    }
}

// =========================
// All Pods Management
// =========================

// Task to build all pods
tasks.register("buildAllPods") {
    group = "pods"
    description = "Build all demonstration pods"
    dependsOn("buildQuarkusPod", "buildPythonImage")
    
    doLast {
        println("üéâ All pods built successfully!")
    }
}

// Task to test all pods
tasks.register("testAllPods") {
    group = "pods"
    description = "Run tests for all demonstration pods"
    dependsOn("testQuarkusPod", "runPythonTests")
    
    doLast {
        println("üéâ All pod tests completed successfully!")
    }
}

// Task to setup all pods
tasks.register("setupAllPods") {
    group = "pods"
    description = "Complete setup of all demonstration pods"
    dependsOn("testAllPods")
    
    doLast {
        println("üéâ All Shadok demonstration pods are ready!")
        println("")
        println("üìã Available pods:")
        println("   ‚ö° Quarkus Hello World (Java)")
        println("      - Dev mode: ./gradlew runQuarkusDev")
        println("      - URL: http://localhost:8080")
        println("")
        println("   üêç Python Hello World (FastAPI)")
        println("      - Dev mode: ./gradlew runPythonDev") 
        println("      - URL: http://localhost:8000")
        println("")
        println("üí° Use './gradlew tasks --group pods' to see all pod tasks")
    }
}

// Task to show pods status
tasks.register("podsStatus") {
    group = "pods"
    description = "Show status of all demonstration pods"
    
    doLast {
        println("üìä Shadok Demonstration Pods Status")
        println("=".repeat(50))
        println("")
        
        println("‚ö° QUARKUS HELLO WORLD")
        println("   üìÅ Directory: ${quarkusPodDir.absolutePath}")
        println("   üîß Built: ${if (file("$quarkusPodDir/build").exists()) "‚úÖ Yes" else "‚ùå No"}")
        println("   üìÑ K8s manifests: ${if (file("$quarkusPodDir/build/kubernetes").exists()) "‚úÖ Generated" else "‚ùå Not found"}")
        println("")
        
        println("üêç PYTHON HELLO WORLD")
        println("   üìÅ Directory: ${pythonPodDir.absolutePath}")
        println("   üêç Virtual env: ${if (pythonVenvDir.exists()) "‚úÖ Created" else "‚ùå Not found"}")
        println("   üì¶ Dependencies: ${if (file("$pythonVenvDir/pyvenv.cfg").exists()) "‚úÖ Installed" else "‚ùå Not installed"}")
        println("")
        
        println("üéØ Quick commands:")
        println("   ./gradlew setupAllPods     # Setup everything")
        println("   ./gradlew testAllPods      # Test all pods")
        println("   ./gradlew buildAllPods     # Build all pods")
        println("   ./gradlew runQuarkusDev    # Start Quarkus")
        println("   ./gradlew runPythonDev     # Start Python")
        println("=".repeat(50))
    }
}

// Task to show help for pods
tasks.register("podsHelp") {
    group = "pods"
    description = "Show detailed help for working with Shadok demonstration pods"
    
    doLast {
        println("üéØ Shadok Demonstration Pods - Complete Guide")
        println("=".repeat(60))
        println("")
        
        println("üöÄ QUICK START")
        println("   ./gradlew setupAllPods     # Configure everything")
        println("   ./gradlew podsStatus       # Check current status")
        println("   ./gradlew testAllPods      # Run all tests")
        println("")
        
        println("‚ö° QUARKUS POD (Java)")
        println("   üìÇ Location: pods/quarkus-hello/")
        println("   üîß Technology: Quarkus 3.8.1 + JAX-RS")
        println("   üìã Commands:")
        println("      ./gradlew buildQuarkusPod       # Build application")
        println("      ./gradlew testQuarkusPod        # Run tests")
        println("      ./gradlew runQuarkusDev         # Dev mode (port 8080)")
        println("      ./gradlew generateQuarkusK8s    # Generate K8s manifests")
        println("      ./gradlew cleanQuarkusPod       # Clean build")
        println("   üåê Endpoints (http://localhost:8080):")
        println("      GET /hello                      # Text response")
        println("      GET /hello/json                 # JSON response")
        println("      GET /q/health                   # Health check")
        println("")
        
        println("üêç PYTHON POD (FastAPI)")
        println("   üìÇ Location: pods/python-hello/")
        println("   üîß Technology: Python 3.11 + FastAPI")
        println("   üìã Commands:")
        println("      ./gradlew setupPython           # Complete setup")
        println("      ./gradlew checkPython           # Check Python availability")
        println("      ./gradlew createPythonVenv      # Create virtual environment")
        println("      ./gradlew installPythonDeps     # Install dependencies")
        println("      ./gradlew runPythonTests        # Run tests")
        println("      ./gradlew runPythonDev          # Dev mode (port 8000)")
        println("      ./gradlew buildPythonImage      # Build Docker image")
        println("      ./gradlew runPythonDocker       # Run with Docker")
        println("      ./gradlew pythonStatus          # Show detailed status")
        println("      ./gradlew cleanPython           # Clean environment")
        println("   üåê Endpoints (http://localhost:8000):")
        println("      GET /hello                      # Text response")
        println("      GET /hello/json                 # JSON response")
        println("      GET /health                     # Health check")
        println("      GET /docs                       # Interactive docs (Swagger)")
        println("      GET /openapi.json               # OpenAPI specification")
        println("")
        
        println("üõ† DEVELOPMENT WORKFLOW")
        println("   1. Setup: ./gradlew setupAllPods")
        println("   2. Check: ./gradlew podsStatus")
        println("   3. Test:  ./gradlew testAllPods")
        println("   4. Dev:   ./gradlew runQuarkusDev  (terminal 1)")
        println("   5. Dev:   ./gradlew runPythonDev   (terminal 2)")
        println("   6. Open:  http://localhost:8080 and http://localhost:8000")
        println("")
        
        println("üìö TASK GROUPS")
        println("   ./gradlew tasks --group pods           # All pod tasks")
        println("   ./gradlew tasks --group quarkus-pods   # Quarkus specific")
        println("   ./gradlew tasks --group python-pods    # Python specific")
        println("")
        
        println("üí° TIPS")
        println("   ‚Ä¢ Both applications support live reload for development")
        println("   ‚Ä¢ Python tests include async endpoint testing")
        println("   ‚Ä¢ Quarkus generates K8s manifests automatically")
        println("   ‚Ä¢ All containers are based on optimized images")
        println("   ‚Ä¢ Use Ctrl+C to stop development servers")
        println("=".repeat(60))
    }
}

// Task to check code formatting status
tasks.register("formatStatus") {
    group = "formatting"
    description = "Show status of code formatting for all files"
    
    doLast {
        println("üìù Code Formatting Status")
        println("=".repeat(50))
        println("")
        
        println("üîß Spotless Configuration:")
        println("   ‚òï Java: Google Java Format + remove unused imports")
        println("   üìÑ Markdown: Prettier with prose wrap (80 chars)")
        println("   ‚öôÔ∏è  TOML: Basic formatting (indent, trim, newline)")
        println("")
        
        println("üìÇ Target files:")
        println("   ‚òï Java: src/**/*.java")
        println("   üìÑ Markdown: **/*.md (excluding venv/, build/, etc.)")
        println("   ‚öôÔ∏è  TOML: **/*.toml (excluding venv/, build/, etc.)")
        println("")
        
        println("üéØ Quick commands:")
        println("   ./gradlew spotlessCheck    # Check formatting")
        println("   ./gradlew spotlessApply    # Apply formatting")
        println("   ./gradlew formatStatus     # Show this status")
        println("")
        
        println("üí° All files are currently formatted correctly! ‚úÖ")
        println("=".repeat(50))
    }
}
