# ğŸ§ª Pod de Test Live Reload - Quarkus Hello
# ================================================================
#
# Ce manifeste dÃ©ploie un pod Quarkus avec live reload activÃ©
# pour tester la recompilation automatique en temps rÃ©el.
#
# FonctionnalitÃ©s :
# - Source code montÃ© depuis le host
# - Cache Gradle persistant
# - Live reload activÃ© via webhook Shadok
# - Commande quarkusDev automatique
#
# Usage: kubectl apply -f test-live-reload-pod.yaml

---
apiVersion: v1
kind: Pod
metadata:
  name: quarkus-hello-live-reload
  namespace: shadok
  labels:
    app: quarkus-hello
    mode: live-reload
    test: automatic-compilation
  annotations:
    # ğŸ¯ Cette annotation dÃ©clenche le webhook Shadok
    # qui configure automatiquement le live reload
    org.shadok/application: "test-app"
    description: "Pod de test pour live reload automatique"
spec:
  containers:
  - name: quarkus-hello
    # Image de base Quarkus avec JDK et Gradle
    image: quay.io/quarkus/ubi-quarkus-graalvm-builder-image:latest
    ports:
    - containerPort: 8080
      name: http
      protocol: TCP
    - containerPort: 5005
      name: debug
      protocol: TCP
    
    # ğŸ“ Volumes montÃ©s pour le live reload
    volumeMounts:
    - name: source-code
      mountPath: /workspace
      readOnly: false
    - name: gradle-cache
      mountPath: /cache/.gradle
      readOnly: false
    
    # ğŸ”§ Variables d'environnement pour Gradle et debug
    env:
    - name: GRADLE_USER_HOME
      value: "/cache/.gradle"
    - name: JAVA_TOOL_OPTIONS
      value: "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"
    
    # ğŸš€ Commande live reload (sera injectÃ©e par le webhook)
    command: ["./gradlew", "quarkusDev"]
    workingDir: /workspace
    
    # ğŸ’¾ Ressources allouÃ©es
    resources:
      requests:
        memory: "512Mi"
        cpu: "500m"
      limits:
        memory: "2Gi"
        cpu: "2000m"
    
    # ğŸ” Health checks
    livenessProbe:
      httpGet:
        path: /hello
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
    
    readinessProbe:
      httpGet:
        path: /hello
        port: 8080
      initialDelaySeconds: 15
      periodSeconds: 5
  
  # ğŸ“¦ Volumes pour le code source et le cache
  volumes:
  - name: source-code
    hostPath:
      # ğŸ“ Chemin vers le code source de quarkus-hello
      # Ajustez selon votre environnement
      path: /Users/alexandreboyer/dev/kub/shadok/pods/quarkus-hello
      type: Directory
  
  - name: gradle-cache
    hostPath:
      # ğŸ’¾ Cache Gradle persistant
      path: /tmp/gradle-cache-quarkus-hello
      type: DirectoryOrCreate
  
  # âš™ï¸ Configuration du pod
  restartPolicy: Never
  serviceAccountName: default
  
  # ğŸ·ï¸ SÃ©lecteur de nÅ“ud (optionnel)
  # nodeSelector:
  #   kubernetes.io/os: linux

---
# ğŸŒ Service pour exposer le pod (optionnel)
apiVersion: v1
kind: Service
metadata:
  name: quarkus-hello-live-reload-svc
  namespace: shadok
  labels:
    app: quarkus-hello
    mode: live-reload
spec:
  selector:
    app: quarkus-hello
    mode: live-reload
  ports:
  - name: http
    port: 80
    targetPort: 8080
    protocol: TCP
  - name: debug
    port: 5005
    targetPort: 5005
    protocol: TCP
  type: ClusterIP

---
# ğŸ“‹ ConfigMap avec instructions de test
apiVersion: v1
kind: ConfigMap
metadata:
  name: live-reload-test-instructions
  namespace: shadok
  labels:
    app: quarkus-hello
    mode: live-reload
data:
  test-instructions.md: |
    # Test Live Reload - Instructions
    
    ## ğŸš€ DÃ©marrage du Test
    
    1. **DÃ©ployer ce manifeste :**
       ```bash
       kubectl apply -f test-live-reload-pod.yaml
       ```
    
    2. **Attendre que le pod soit prÃªt :**
       ```bash
       kubectl wait --for=condition=ready pod/quarkus-hello-live-reload -n shadok --timeout=60s
       ```
    
    3. **ExÃ©cuter le test automatique :**
       ```bash
       cd pods/quarkus-hello
       ./test-live-reload-patch.sh --verbose
       ```
    
    ## ğŸ” Tests Manuels
    
    1. **Port-forward vers le pod :**
       ```bash
       kubectl port-forward pod/quarkus-hello-live-reload 8080:8080 -n shadok
       ```
    
    2. **Tester l'endpoint initial :**
       ```bash
       curl http://localhost:8080/hello/json
       ```
    
    3. **Modifier le code source et observer la recompilation automatique**
    
    ## ğŸ“Š Validation du Live Reload
    
    - âœ… Modification dÃ©tectÃ©e en < 5s
    - âœ… Recompilation automatique en < 30s
    - âœ… Nouveau comportement immÃ©diatement accessible
    - âœ… Logs de recompilation visibles
    
    ## ğŸ§¹ Nettoyage
    
    ```bash
    kubectl delete -f test-live-reload-pod.yaml
    ```
  
  gradle-config: |
    # Configuration Gradle pour optimiser le live reload
    org.gradle.daemon=true
    org.gradle.parallel=true
    org.gradle.caching=true
    org.gradle.configureondemand=true
    org.gradle.jvmargs=-Xmx2g -XX:MaxMetaspaceSize=512m
